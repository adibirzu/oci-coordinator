name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
  OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
  OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
  REGISTRY: ${{ secrets.OCI_REGISTRY_ENDPOINT }} # e.g. iad.ocir.io/tenancy/repo

jobs:
  build-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dev/oci-coordinator

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        
    - name: Install dependencies
      run: poetry install
      
    - name: Run linting
      run: |
        poetry run ruff check .
        poetry run black --check .
        
    - name: Run tests
      run: poetry run pytest

    - name: Build Backend Container
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        docker build -t oci-coordinator:${{ github.sha }} .
        # In a real setup, we would tag and push to OCIR here
        # docker tag oci-coordinator:${{ github.sha }} $REGISTRY/oci-coordinator:${{ github.sha }}
        # docker push $REGISTRY/oci-coordinator:${{ github.sha }}

  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dev/viewapp

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './dev/viewapp/package-lock.json'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build
      run: npm run build
      
    - name: Build Frontend Container
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        docker build -t viewapp:${{ github.sha }} .
        # docker tag viewapp:${{ github.sha }} $REGISTRY/viewapp:${{ github.sha }}
        # docker push $REGISTRY/viewapp:${{ github.sha }}

  package-for-cloud-shell:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Cloud Shell Artifact
      run: |
        mkdir -p deploy-package
        cp -r dev/oci-coordinator deploy-package/
        cp -r dev/viewapp deploy-package/
        # Remove heavy dev dirs
        rm -rf deploy-package/oci-coordinator/.venv
        rm -rf deploy-package/oci-coordinator/__pycache__
        rm -rf deploy-package/viewapp/node_modules
        
        # Add setup script
        echo '#!/bin/bash' > deploy-package/setup_cloud_shell.sh
        echo 'python3 -m venv .venv' >> deploy-package/setup_cloud_shell.sh
        echo 'source .venv/bin/activate' >> deploy-package/setup_cloud_shell.sh
        echo 'pip install -r oci-coordinator/requirements.txt' >> deploy-package/setup_cloud_shell.sh
        echo 'echo "Ready! Run: python -m src.main"' >> deploy-package/setup_cloud_shell.sh
        chmod +x deploy-package/setup_cloud_shell.sh
        
        zip -r oci-agent-bundle.zip deploy-package
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: oci-agent-bundle
        path: oci-agent-bundle.zip
        retention-days: 5
